#!/usr/bin/env bash
# Claude Code wrapper for CLIProxyAPI
#
# This script provides a separate command to use Claude Code with CLIProxyAPI,
# while keeping the original 'claude' command untouched.
#
# Usage:
#   claude-cliproxy [--model <provider>] [claude arguments...]
#
# Examples:
#   claude-cliproxy "explain this code"
#   claude-cliproxy --model gemini "explain this code"
#   claude-cliproxy --model claude "explain this code"
#   claude-cliproxy --version
#
# Model Providers:
#   --model claude   Use Antigravity Claude models (default)
#   --model gemini   Use Gemini models (gemini-3-pro-preview)
#   --model flash    Use Gemini Flash models (gemini-2.5-flash)
#
# Configuration:
#   Set CLIPROXY_BASE_URL in ~/.env (default: http://127.0.0.1:8080)

set -euo pipefail

# Default CLIProxyAPI URL
DEFAULT_CLIPROXY_URL="http://127.0.0.1:8080"

# Use CLIPROXY_BASE_URL from environment, or fall back to default
PROXY_URL="${CLIPROXY_BASE_URL:-$DEFAULT_CLIPROXY_URL}"

# Set CLIProxyAPI URL for Claude Code
export ANTHROPIC_BASE_URL="$PROXY_URL"
export ANTHROPIC_AUTH_TOKEN="sk-dummy"

# Parse --model argument
MODEL_PROVIDER="claude"  # default
CLAUDE_ARGS=()

while [[ $# -gt 0 ]]; do
  case $1 in
    --model)
      if [[ $# -lt 2 ]]; then
        echo "Error: --model requires an argument (claude|gemini|flash)" >&2
        exit 1
      fi
      MODEL_PROVIDER="$2"
      shift 2
      ;;
    *)
      CLAUDE_ARGS+=("$1")
      shift
      ;;
  esac
done

# Set models based on provider
case "$MODEL_PROVIDER" in
  claude)
    # Use Antigravity Claude models
    export ANTHROPIC_DEFAULT_SONNET_MODEL="gemini-claude-sonnet-4-5"
    export ANTHROPIC_DEFAULT_OPUS_MODEL="gemini-claude-sonnet-4-5"
    export ANTHROPIC_DEFAULT_HAIKU_MODEL="gemini-2.5-flash"
    ;;
  gemini)
    # Use Gemini native models
    export ANTHROPIC_DEFAULT_SONNET_MODEL="gemini-3-pro-preview"
    export ANTHROPIC_DEFAULT_OPUS_MODEL="gemini-3-pro-preview"
    export ANTHROPIC_DEFAULT_HAIKU_MODEL="gemini-3-flash-preview"
    ;;
  flash)
    # Use Gemini Flash for all (fastest)
    export ANTHROPIC_DEFAULT_SONNET_MODEL="gemini-2.5-flash"
    export ANTHROPIC_DEFAULT_OPUS_MODEL="gemini-2.5-flash"
    export ANTHROPIC_DEFAULT_HAIKU_MODEL="gemini-2.5-flash-lite"
    ;;
  *)
    echo "Error: Unknown model provider '$MODEL_PROVIDER'" >&2
    echo "Available providers: claude, gemini, flash" >&2
    exit 1
    ;;
esac

# Forward remaining arguments to claude
exec claude "${CLAUDE_ARGS[@]}"
